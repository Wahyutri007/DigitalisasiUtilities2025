@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@model IEnumerable<UtilitiesHR.Models.Material>

@{
    ViewData["Title"] = "Material Utilities";
    ViewData["Breadcrumb"] = "Material Utilities";

    var q = Context.Request.Query["q"].ToString();
    var jenisBarangId = Context.Request.Query["jenisBarangId"].ToString();
}

<form id="token-form" method="post" class="d-none">
    @Html.AntiForgeryToken()
</form>

@section Styles {
    <style>
        /* ===== HEADER ACTIONS (KANAN BREADCRUMB) ===== */
        .material-actions .btn {
            min-width: 38px;
        }

            .material-actions .btn i {
                font-size: 1rem;
            }

        .btn-pill-outline {
            background: #ffffff;
            border-radius: 999px;
            border: 1px solid #d0d7e6;
            color: #0f172a;
        }

            .btn-pill-outline i {
                color: #0a5db0;
            }

            .btn-pill-outline:hover {
                background: #f3f6fb;
                border-color: #c3cce3;
            }

        .btn-pill-primary {
            border-radius: 999px;
            background: #0f7bd9;
            border-color: #0f7bd9;
            color: #ffffff;
            box-shadow: 0 4px 12px rgba(15, 123, 217, .35);
        }

            .btn-pill-primary:hover {
                background: #0a5db0;
                border-color: #0a5db0;
            }

            .btn-pill-primary i {
                color: #ffffff;
            }

        @@media (max-width: 575.98px) {
            .material-actions .btn span {
                display: none !important; /* HP: icon saja */
            }

            .material-actions .btn {
                padding-inline: .55rem;
            }
        }

        /* ===== WRAPPER CARD TABEL ===== */
        .material-table-wrapper {
            border-radius: 16px;
            border: 1px solid var(--line);
            box-shadow: 0 10px 32px rgba(15,23,42,.06);
            padding: 1.2rem 1.4rem;
            background: #ffffff;
            margin-top: .5rem;
        }

        .material-table {
            border-collapse: separate;
            border-spacing: 0;
            margin-bottom: 0;
        }

            .material-table thead th {
                background-color: #f3f6fb;
                color: #1f2937;
                font-weight: 600;
                font-size: .8rem;
                padding: .7rem 1rem;
                border-bottom: 2px solid #e1e6f0 !important;
                vertical-align: middle;
                white-space: nowrap;
            }

            .material-table tbody td {
                padding: .65rem 1rem;
                border-bottom: 1px solid #eef1f7;
                vertical-align: middle;
                font-size: .8rem;
            }

            .material-table tbody tr:nth-child(odd) {
                background-color: #ffffff;
            }

            .material-table tbody tr:nth-child(even) {
                background-color: #f9fafc;
            }

            .material-table tbody tr:hover {
                background-color: #edf4ff;
            }

        .material-table-actions {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: .35rem;
            white-space: nowrap;
        }

        .material-action-btn {
            width: 32px;
            height: 32px;
            border-radius: 999px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: none;
            font-size: 14px;
            padding: 0;
            box-shadow: 0 2px 6px rgba(15,23,42,.12);
            transition: transform .12s ease, box-shadow .12s ease, background-color .12s ease;
        }

            .material-action-btn:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 10px rgba(15,23,42,.16);
            }

        .material-action-info {
            background: #e0f2fe;
            color: #0369a1;
        }

        .material-action-edit {
            background: #fef3c7;
            color: #92400e;
        }

        .material-action-delete {
            background: #fee2e2;
            color: #b91c1c;
        }

        .material-action-info:hover {
            background: #bae6fd;
        }

        .material-action-edit:hover {
            background: #fde68a;
        }

        .material-action-delete:hover {
            background: #fecaca;
        }

        .material-action-btn:focus {
            outline: 2px solid rgba(15,123,217,.35);
            outline-offset: 1px;
        }
    </style>
}

@* ====== TOMBOL DI HEADER (SEJAJAR BREADCRUMB) ====== *@
@section PageActions {
    <div class="material-actions d-flex flex-wrap gap-2 justify-content-end">
        <button class="btn btn-pill-outline" id="btn-import-modal">
            <i class="bi bi-file-earmark-arrow-up me-1"></i>
            <span class="d-none d-md-inline">Import</span>
        </button>

        <div class="btn-group">
            <button class="btn btn-pill-outline dropdown-toggle"
                    type="button"
                    data-bs-toggle="dropdown">
                <i class="bi bi-download me-1"></i>
                <span class="d-none d-md-inline">Template &amp; Export</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li class="dropdown-header">Template Import</li>
                <li>
                    <a class="dropdown-item" asp-action="DownloadImportTemplate">
                        <i class="bi bi-file-earmark-excel me-1"></i>Template Excel
                    </a>
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li class="dropdown-header">Export Data</li>
                <li>
                    <a class="dropdown-item"
                       asp-action="ExportMaterials"
                       asp-route-q="@q"
                       asp-route-jenisBarangId="@jenisBarangId">
                        <i class="bi bi-file-earmark-spreadsheet me-1"></i>Export Excel
                    </a>
                </li>
                <li>
                    <a class="dropdown-item"
                       asp-action="ExportMaterialsCsv"
                       asp-route-q="@q"
                       asp-route-jenisBarangId="@jenisBarangId">
                        <i class="bi bi-filetype-csv me-1"></i>Export CSV
                    </a>
                </li>
            </ul>
        </div>

        <button class="btn btn-pill-primary" id="btn-create-modal">
            <i class="bi bi-plus-lg me-1"></i>
            <span class="d-none d-md-inline">Input Material</span>
        </button>
    </div>
}

@* ====== ISI HALAMAN SESUDAH HEADER GLOBAL ====== *@

<div class="mb-2">
    <div class="text-muted small">
        Daftar master material Utilities beserta stok terakhir.
    </div>
</div>

<div class="material-table-wrapper">
    <div class="table-responsive">
        <table id="tbl-materials"
               class="table material-table align-middle w-100">
            <thead>
                <tr>
                    <th class="text-center" style="width:30px;">#</th>
                    <th>Kode Barang</th>
                    <th>Nama Barang</th>
                    <th>Jenis Barang</th>
                    <th>Posisi Barang</th>
                    <th>Satuan</th>
                    <th class="text-center">Stok</th>
                    <th class="text-center" data-priority="1">Aksi</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var m in Model ?? Enumerable.Empty<UtilitiesHR.Models.Material>())
                {
                    <tr>
                        <td class="text-center"></td>
                        <td>@m.KodeBarang</td>
                        <td>@m.NamaBarang</td>
                        <td>@m.JenisBarang?.Nama</td>
                        <td>@m.PosisiBarang</td>
                        <td>@m.Satuan</td>
                        <td class="text-center fw-bold">@m.JumlahBarang</td>
                        <td class="text-center">
                            <div class="material-table-actions">
                                <a class="material-action-btn material-action-info"
                                   asp-action="Details"
                                   asp-route-id="@m.Id"
                                   title="Detail">
                                    <i class="bi bi-info-circle"></i>
                                </a>
                                <button type="button"
                                        class="material-action-btn material-action-edit btn-edit"
                                        data-id="@m.Id"
                                        title="Edit">
                                    <i class="bi bi-pencil-square"></i>
                                </button>
                                <button type="button"
                                        class="material-action-btn material-action-delete btn-delete"
                                        data-id="@m.Id"
                                        data-nama="@m.NamaBarang"
                                        title="Hapus">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Import -->
<div class="modal fade" id="import-modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Import Transaksi</h5>
                <button type="button" class="btn-close"
                        data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info small">
                    <strong>Format Template:</strong>
                    <ul class="mb-0">
                        <li>
                            Header:
                            <code>
                                KodeBarang, NamaBarang, JenisBarang, PosisiBarang, Satuan,
                                Tanggal (dd/MM/yyyy), Jenis (Masuk/Keluar),
                                Jumlah, PenanggungJawab, Keterangan
                            </code>
                        </li>
                        <li>Isi hanya kolom 1–5 ⇒ master material.</li>
                        <li>Isi Tanggal+Jenis+Jumlah ⇒ transaksi otomatis.</li>
                        <li><code>JenisBarang</code> baru ⇒ otomatis dibuat.</li>
                        <li><code>KodeBarang</code> baru ⇒ otomatis dibuat.</li>
                        <li>Sisa Stok tidak perlu, dihitung otomatis.</li>
                    </ul>
                </div>
                <div class="mb-3">
                    <a asp-action="DownloadImportTemplate"
                       class="btn btn-sm btn-outline-success">
                        <i class="bi bi-file-earmark-excel"></i> Download Template
                    </a>
                </div>

                <form id="import-form" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label class="form-label">Pilih File (.xlsx / .csv)</label>
                        <input type="file"
                               class="form-control"
                               name="file"
                               accept=".xlsx,.csv"
                               required />
                    </div>
                    <div class="d-flex justify-content-end gap-2">
                        <button type="button"
                                class="btn btn-outline-secondary"
                                data-bs-dismiss="modal">
                            <i class="bi bi-x-lg"></i> Batal
                        </button>
                        <button type="submit"
                                class="btn btn-primary">
                            <i class="bi bi-upload"></i> Upload &amp; Import
                        </button>
                    </div>
                </form>

                <div id="import-results"
                     class="mt-3"
                     style="display:none;">
                    <h6>Hasil Import:</h6>
                    <div class="alert mb-2"></div>
                    <ul id="import-errors-list"
                        class="text-danger small"
                        style="max-height:200px;overflow-y:auto;"></ul>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        $(function () {
            const $ajaxModal = $('#ajax-modal'); // modal global dari _Layout
            const $modalBody = $ajaxModal.find('.modal-body');
            const $modalTitle = $ajaxModal.find('.modal-title');

            const $importModal   = $('#import-modal');
            const $importForm    = $('#import-form');
            const $importResults = $('#import-results');
            const $importAlert   = $importResults.find('.alert');
            const $importErrors  = $('#import-errors-list');

            function initSelect2() {
                const selects = $modalBody.find('.select2-modal');
                if (!selects.length) return;
                selects.each(function () {
                    const $s = $(this);
                    if ($s.data('select2')) $s.select2('destroy');
                    $s.select2({
                        theme: "bootstrap-5",
                        dropdownParent: $ajaxModal.find('.modal-content'),
                        tags: true
                    });
                });
            }

            const table = $('#tbl-materials').DataTable({
                responsive: true,
                dom:
                    "<'row g-2 mb-3'<'col-6 col-md-4'l><'col-6 col-md-4 offset-md-4'f>>" +
                    "<'row'<'col-sm-12'tr>>" +
                    "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7 d-flex justify-content-end'p>>",
                order: [[1, 'asc']],
                pageLength: 25,
                lengthMenu: [10, 25, 50, 100],
                language: {
                    search: "Cari:",
                    lengthMenu: "_MENU_ baris",
                    info: "_START_–_END_ dari _TOTAL_",
                    infoEmpty: "Tidak ada data",
                    zeroRecords: "Tidak ditemukan",
                    paginate: {
                        first: "<<",
                        last: ">>",
                        next: ">",
                        previous: "<"
                    }
                },
                columnDefs: [
                    { targets: 0, orderable: false, searchable: false },
                    { targets: 6, orderable: false, searchable: false },
                    { targets: 7, orderable: false, searchable: false }
                ]
            });

            // === PENOMORAN KOLOM # ===
            table.on('draw.dt', function () {
                const info = table.page.info();
                table.column(0, { search: 'applied', order: 'applied' })
                    .nodes()
                    .each(function (cell, i) {
                        cell.innerHTML = info.start + i + 1;
                    });
            }).draw();

            // CREATE
            $('#btn-create-modal').on('click', function () {
                $modalTitle.text('Input Material');
                $modalBody.html('<div class="text-center py-4 text-muted small">Memuat formulir…</div>');
                $modalBody.load('@Url.Action("Create")', function (res, status) {
                    if (status === 'error') {
                        $modalBody.html("<div class='alert alert-danger mb-0'>Gagal memuat form.</div>");
                    } else {
                        initSelect2();
                    }
                });
                const instance = bootstrap.Modal.getOrCreateInstance($ajaxModal[0]);
                instance.show();
            });

            // EDIT
            $('#tbl-materials').on('click', '.btn-edit', function () {
                const id = $(this).data('id');
                $modalTitle.text('Edit Material');
                $modalBody.html('<div class="text-center py-4 text-muted small">Memuat formulir…</div>');
                $modalBody.load('@Url.Action("Edit")?id=' + id, function (res, status) {
                    if (status === 'error') {
                        $modalBody.html("<div class='alert alert-danger mb-0'>Gagal memuat form.</div>");
                    } else {
                        initSelect2();
                    }
                });
                const instance = bootstrap.Modal.getOrCreateInstance($ajaxModal[0]);
                instance.show();
            });

            // DELETE
            $('#tbl-materials').on('click', '.btn-delete', function () {
                const id   = $(this).data('id');
                const nama = $(this).data('nama');
                const token = $('#token-form').find('input[name="__RequestVerificationToken"]').val();

                Swal.fire({
                    title: 'Anda yakin?',
                    text: `Material "${nama}" akan dihapus permanen.`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Ya, hapus',
                    cancelButtonText: 'Batal'
                }).then(r => {
                    if (!r.isConfirmed) return;

                    $.post('@Url.Action("Delete")/' + id, {
                        "__RequestVerificationToken": token
                    })
                        .done(res => {
                            if (res.success) {
                                Swal.fire('Berhasil', res.message, 'success')
                                    .then(() => location.reload());
                            } else {
                                Swal.fire('Gagal', res.message, 'error');
                            }
                        })
                        .fail(() => {
                            Swal.fire('Error', 'Terjadi kesalahan server.', 'error');
                        });
                });
            });

            // SUBMIT MODAL (Create/Edit)
            $('body').on('submit', '#ajax-form', function (e) {
                e.preventDefault();
                const $form = $(this);

                $.ajax({
                    url: $form.attr('action'),
                    type: 'POST',
                    data: $form.serialize(),
                    success: function (res) {
                        if (res && res.success === true) {
                            const instance = bootstrap.Modal.getOrCreateInstance($ajaxModal[0]);
                            instance.hide();
                            Swal.fire('Berhasil', res.message, 'success')
                                .then(() => location.reload());
                        } else if (res && res.success === false) {
                            Swal.fire('Gagal', res.message, 'error');
                        } else {
                            $modalBody.html(res);
                            initSelect2();
                            $.validator.unobtrusive.parse('#ajax-form');
                        }
                    },
                    error: function () {
                        Swal.fire('Error', 'Terjadi kesalahan server.', 'error');
                    }
                });
            });

            // IMPORT
            $('#btn-import-modal').on('click', function () {
                $importForm[0].reset();
                $importResults.hide();
                $importAlert.removeClass('alert-success alert-danger').text('');
                $importErrors.empty();
                const instance = bootstrap.Modal.getOrCreateInstance($importModal[0]);
                instance.show();
            });

            $importForm.on('submit', function (e) {
                e.preventDefault();
                const token = $('#token-form').find('input[name="__RequestVerificationToken"]').val();
                const formData = new FormData(this);
                formData.append("__RequestVerificationToken", token);

                $importResults.hide();
                $importAlert.removeClass('alert-success alert-danger').text('');
                $importErrors.empty();

                $.ajax({
                    url: '@Url.Action("ImportTransaksi")',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (res) {
                        if (res.success) {
                            $importAlert.addClass('alert-success').text(res.message);
                            $importResults.show();
                            Swal.fire('Berhasil', res.message, 'success')
                                .then(() => location.reload());
                        } else {
                            $importAlert.addClass('alert-danger')
                                .text(res.message || 'Import gagal.');
                            if (res.errors && res.errors.length) {
                                res.errors.forEach(e =>
                                    $importErrors.append(`<li>${e}</li>`));
                            }
                            $importResults.show();
                        }
                    },
                    error: function () {
                        $importAlert.addClass('alert-danger')
                            .text('Terjadi kesalahan server saat import.');
                        $importResults.show();
                    }
                });
            });
        });
    </script>
}
