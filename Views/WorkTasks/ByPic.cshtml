@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@using UtilitiesHR.Models
@model UtilitiesHR.Controllers.WorkTasksController.WorkTasksByPicVM

@{
    ViewData["Title"] = $"Detail Pekerjaan - {Model.PicName}";
    ViewData["Breadcrumb"] = "Outstanding Pekerjaan / Detail PIC";

    var tasks = Model.Tasks ?? new List<WorkTask>();
}

<form id="afTokenForm" style="display:none">
    @Html.AntiForgeryToken()
</form>

@section Styles {
    <link rel="stylesheet" href="https://cdn.datatables.net/2.0.7/css/dataTables.bootstrap5.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/3.0.2/css/responsive.bootstrap5.css" />
    <!-- Select2 utk modal Create/Edit di halaman ini -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@@ttskch/select2-bootstrap4-theme@1.5.2/dist/select2-bootstrap4.min.css" />

    <style>
        .wt-wrapper {
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 10px 32px rgba(15,23,42,.06);
            padding: 1.2rem 1.4rem;
            background: #fff;
        }

        .wt-summary-card {
            border-radius: 14px;
            border: 1px solid #e2e8f0;
            background: #fff;
            padding: .8rem 1rem;
            box-shadow: 0 6px 18px rgba(15,23,42,.04);
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: .75rem;
        }

        .wt-summary-main {
            display: flex;
            flex-direction: column;
            gap: .15rem;
        }

        .wt-summary-label {
            font-size: .7rem;
            text-transform: uppercase;
            letter-spacing: .04em;
            color: #6b7280;
        }

        .wt-summary-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #111827;
        }

        .wt-summary-sub {
            font-size: .75rem;
            color: #6b7280;
        }

        .wt-summary-icon {
            width: 30px;
            height: 30px;
            border-radius: 999px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: #e5f0ff;
            color: #0f7bd9;
            font-size: 1rem;
        }

            .wt-summary-icon.pending {
                background: #fee2e2;
                color: #b91c1c;
            }

            .wt-summary-icon.progress {
                background: #fef3c7;
                color: #92400e;
            }

            .wt-summary-icon.done {
                background: #dcfce7;
                color: #166534;
            }

        .wt-table {
            border-collapse: separate;
            border-spacing: 0;
            margin-bottom: 0;
        }

            .wt-table thead th {
                background-color: #f3f6fb;
                color: #1f2937;
                font-weight: 600;
                font-size: .8rem;
                padding: .7rem 1rem;
                border-bottom: 2px solid #e1e6f0 !important;
                vertical-align: middle;
                white-space: nowrap;
            }

            .wt-table tbody td {
                padding: .65rem 1rem;
                border-bottom: 1px solid #eef1f7;
                vertical-align: middle;
                font-size: .8rem;
            }

            .wt-table tbody tr:nth-child(odd) {
                background: #fff;
            }

            .wt-table tbody tr:nth-child(even) {
                background: #f9fafc;
            }

            .wt-table tbody tr:hover {
                background: #edf4ff;
            }

        .table-actions {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: .35rem;
            white-space: nowrap;
        }

        .table-action-btn {
            width: 34px;
            height: 34px;
            border-radius: 999px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: none;
            font-size: 14px;
            padding: 0;
            box-shadow: 0 2px 6px rgba(15,23,42,.12);
            transition: transform .12s ease, box-shadow .12s ease, background-color .12s ease;
        }

            .table-action-btn i {
                font-size: 15px;
            }

            .table-action-btn:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 10px rgba(15,23,42,.16);
            }

        .table-action-edit {
            background: #fef3c7;
            color: #92400e;
        }

        .table-action-delete {
            background: #fee2e2;
            color: #b91c1c;
        }

        .table-action-edit:hover {
            background: #fde68a;
        }

        .table-action-delete:hover {
            background: #fecaca;
        }

        .wt-badge-table {
            border-radius: 999px;
            padding: .1rem .5rem;
            font-size: .7rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: .25rem;
        }

        /* ===== BADGE STATUS ===== */
        .wt-badge-status-pending {
            background: #fee2e2;
            color: #b91c1c;
        }

        .wt-badge-status-inprogress {
            background: #fef3c7;
            color: #92400e;
        }

        .wt-badge-status-done {
            background: #dcfce7;
            color: #166534;
        }

        /* ===== BADGE PRIORITY ===== */
        .wt-badge-prio-low {
            background: #e5e7eb;
            color: #374151;
        }

        .wt-badge-prio-medium {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .wt-badge-prio-high {
            background: #ffedd5;
            color: #c2410c;
        }

        .wt-badge-prio-emergency {
            background: #fee2e2;
            color: #b91c1c;
        }

        @@media (max-width:575.98px) {
            .table-actions {
                justify-content: center;
            }
        }

        /* ====== MOBILE BOTTOM-SHEET MODAL UNTUK #ajax-modal ====== */
        #ajax-modal .modal-dialog {
            max-width: 700px;
        }

        @@media (max-width: 575.98px) {
            #ajax-modal .modal-dialog {
                margin: 0;
                max-width: 100%;
                width: 100%;
                height: 100%;
                display: flex;
                align-items: flex-end; /* nempel di bawah */
            }

            #ajax-modal .modal-content {
                width: 100%;
                max-height: 92vh;
                border-radius: 16px 16px 0 0 !important;
                margin: 0;
            }

            #ajax-modal .modal-header {
                border-bottom: 1px solid #e5e7eb;
                padding-bottom: 0.25rem;
            }
        }
    </style>
}

@section PageActions {
    <div class="feature-header-actions d-flex align-items-center gap-2 flex-wrap">
        <a asp-action="Index" class="btn btn-pill-outline">
            <i class="bi bi-arrow-left me-1"></i>
            <span class="d-none d-md-inline">Kembali ke Outstanding</span>
            <span class="d-inline d-md-none">Kembali</span>
        </a>

        <!-- TOMBOL HAPUS TERPILIH -->
        <button type="button"
                id="btn-bulk-delete"
                class="btn btn-pill-outline d-none"
                disabled>
            <i class="bi bi-trash3 me-1"></i>
            <span class="d-none d-md-inline">Hapus terpilih</span>
            <span class="d-inline d-md-none">Hapus</span>
        </button>

        <button type="button" id="btn-add-task-pic" class="btn btn-pill-primary">
            <i class="bi bi-plus-lg me-1"></i>
            <span class="d-none d-md-inline">Tambah Pekerjaan (PIC ini)</span>
            <span class="d-inline d-md-none">Tambah</span>
        </button>
    </div>
}

<!-- SUMMARY -->
<div class="row g-3 mb-3">
    <div class="col-6 col-md-3">
        <div class="wt-summary-card">
            <div class="wt-summary-main">
                <div class="wt-summary-label">Total</div>
                <div class="wt-summary-value">@Model.Total</div>
                <div class="wt-summary-sub">Semua pekerjaan</div>
            </div>
            <div class="wt-summary-icon">
                <i class="bi bi-kanban"></i>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="wt-summary-card">
            <div class="wt-summary-main">
                <div class="wt-summary-label">Pending</div>
                <div class="wt-summary-value">@Model.Pending</div>
                <div class="wt-summary-sub">Belum dieksekusi</div>
            </div>
            <div class="wt-summary-icon pending">
                <i class="bi bi-hourglass-split"></i>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="wt-summary-card">
            <div class="wt-summary-main">
                <div class="wt-summary-label">InProgress</div>
                <div class="wt-summary-value">@Model.InProgress</div>
                <div class="wt-summary-sub">Sedang dikerjakan</div>
            </div>
            <div class="wt-summary-icon progress">
                <i class="bi bi-arrow-repeat"></i>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="wt-summary-card">
            <div class="wt-summary-main">
                <div class="wt-summary-label">Done</div>
                <div class="wt-summary-value">@Model.Done</div>
                <div class="wt-summary-sub">Sudah closed</div>
            </div>
            <div class="wt-summary-icon done">
                <i class="bi bi-check-circle"></i>
            </div>
        </div>
    </div>
</div>

<div class="wt-wrapper">
    <h6 class="mb-3">
        PIC: <strong>@Model.PicName</strong>
    </h6>

    <!-- tabel -->
    <div class="table-responsive">
        <table id="tbl-tasks" class="table wt-table align-middle w-100">
            <thead>
                <tr>
                    <th class="text-center" style="width:40px;">
                        <div class="form-check d-flex justify-content-center align-items-center gap-1 mb-0">
                            <input class="form-check-input" type="checkbox" id="wt-check-all" />
                        </div>
                    </th>
                    <th class="text-center" style="width:40px;">No</th>
                    <th>Nama Pekerjaan</th>
                    <th class="text-center">Start</th>
                    <th class="text-center">Due</th>
                    <th class="text-center">Selesai</th>
                    <th class="text-center">Status</th>
                    <th class="text-center">Progress</th>
                    <th class="text-center">Prioritas</th>
                    <th class="text-center all" style="width:110px;">Aksi</th>
                </tr>
            </thead>
            <tbody>
                @{
                    var no = 1;
                    foreach (var t in tasks)
                    {
                        string statusClass = "wt-badge-status-pending";
                        string statusText = "Pending";
                        string statusIcon = "bi-hourglass-split";

                        if (t.Status == WorkTaskStatus.InProgress)
                        {
                            statusClass = "wt-badge-status-inprogress";
                            statusText = "In Progress";
                            statusIcon = "bi-arrow-repeat";
                        }
                        else if (t.Status == WorkTaskStatus.Done)
                        {
                            statusClass = "wt-badge-status-done";
                            statusText = "Done";
                            statusIcon = "bi-check-circle";
                        }

                        string prioClass = "wt-badge-prio-low";
                        string prioIcon = "bi-flag";
                        if (t.Prioritas == WorkTaskPriority.Medium)
                        {
                            prioClass = "wt-badge-prio-medium";
                            prioIcon = "bi-flag";
                        }
                        else if (t.Prioritas == WorkTaskPriority.High)
                        {
                            prioClass = "wt-badge-prio-high";
                            prioIcon = "bi-flag-fill";
                        }
                        else if (t.Prioritas == WorkTaskPriority.Emergency)
                        {
                            prioClass = "wt-badge-prio-emergency";
                            prioIcon = "bi-exclamation-triangle-fill";
                        }

                        <tr>
                            <td class="text-center">
                                <input type="checkbox" class="wt-check-row" value="@t.Id" />
                            </td>
                            <td class="text-center">@no</td>
                            <td>@t.NamaPekerjaan</td>
                            <td class="text-center">@t.StartDate?.ToString("yyyy-MM-dd")</td>
                            <td class="text-center">@t.DueDate?.ToString("yyyy-MM-dd")</td>
                            <td class="text-center">@t.CompletedDate?.ToString("yyyy-MM-dd")</td>
                            <td class="text-center">
                                <span class="wt-badge-table @statusClass">
                                    <i class="bi @statusIcon"></i> @statusText
                                </span>
                            </td>
                            <td class="text-center">@t.ProgressPercent %</td>
                            <td class="text-center">
                                <span class="wt-badge-table @prioClass">
                                    <i class="bi @prioIcon"></i> @t.Prioritas
                                </span>
                            </td>
                            <td class="text-center all">
                                <div class="table-actions">
                                    <button type="button"
                                            class="table-action-btn table-action-edit btn-edit-task"
                                            data-id="@t.Id"
                                            title="Edit">
                                        <i class="bi bi-pencil-square"></i>
                                    </button>
                                    <button type="button"
                                            class="table-action-btn table-action-delete btn-delete-task"
                                            data-id="@t.Id"
                                            title="Hapus">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        no++;
                    }
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Modal AJAX utk Create/Edit -->
<div class="modal fade" id="ajax-modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="border-radius:16px;">
            <div class="modal-header" style="border-bottom:1px solid #e2e8f0;">
                <h5 class="modal-title mb-0">Form Pekerjaan</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
            </div>
            <div class="modal-body">
                <div class="text-center text-muted py-4">
                    <div class="spinner-border spinner-border-sm mb-2"></div>
                    <div>Memuat...</div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.datatables.net/2.0.7/js/dataTables.js"></script>
    <script src="https://cdn.datatables.net/2.0.7/js/dataTables.bootstrap5.js"></script>
    <script src="https://cdn.datatables.net/responsive/3.0.2/js/dataTables.responsive.js"></script>
    <script src="https://cdn.datatables.net/responsive/3.0.2/js/responsive.bootstrap5.js"></script>

    <!-- Select2 + validation untuk form modal di halaman ini -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/jquery.validate.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-validation-unobtrusive@4.0.0/dist/jquery.validate.unobtrusive.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        function getAfToken() {
            return document.querySelector('#afTokenForm input[name="__RequestVerificationToken"]').value;
        }

        document.addEventListener('DOMContentLoaded', function () {
            const $ = window.jQuery;

            // ================= DATATABLE =================
            try {
                new DataTable('#tbl-tasks', {
                    responsive: true,
                    pageLength: 25,
                    order: [[2, 'asc']],
                    lengthMenu: [10, 25, 50, 100],
                    language: {
                        lengthMenu: "Show _MENU_ entries",
                        search: "Search:",
                        info: "Showing _START_ to _END_ of _TOTAL_ entries",
                        infoEmpty: "Showing 0 to 0 of 0 entries",
                        zeroRecords: "No matching records found",
                        paginate: {
                            first: "<<",
                            last: ">>",
                            next: ">",
                            previous: "<"
                        }
                    },
                    columnDefs: [
                        { targets: 0, orderable: false, searchable: false },
                        {
                            targets: -1,
                            orderable: false,
                            searchable: false,
                            className: 'text-center all',
                            responsivePriority: 1   // kolom Aksi tetap tampil
                        }
                    ]
                });
            } catch (e) { console.error(e); }

            const modalEl = document.getElementById('ajax-modal');
            const bsModal = new bootstrap.Modal(modalEl);
            const $modalBody = $('#ajax-modal .modal-body');
            const $modalTitle = $('#ajax-modal .modal-title');

            // =============== LOAD FORM CREATE (PIC INI) ===============
            $('#btn-add-task-pic').on('click', function () {
                $modalTitle.text('Tambah Pekerjaan - @Model.PicName');
                $modalBody.html(
                    '<div class="text-center py-4 text-muted">' +
                    '<div class="spinner-border spinner-border-sm mb-2"></div>' +
                    '<div>Memuat...</div>' +
                    '</div>');
                bsModal.show();

                $.get('@Url.Action("Create")', { pic: '@Model.PicName' }, function (html) {
                    $modalBody.html(html);
                });
            });

            // =============== LOAD FORM EDIT ===============
            $(document).on('click', '.btn-edit-task', function () {
                const id = $(this).data('id');
                $modalTitle.text('Edit Pekerjaan');
                $modalBody.html(
                    '<div class="text-center py-4 text-muted">' +
                    '<div class="spinner-border spinner-border-sm mb-2"></div>' +
                    '<div>Memuat...</div>' +
                    '</div>');
                bsModal.show();

                $.get('@Url.Action("Edit")', { id: id }, function (html) {
                    $modalBody.html(html);
                });
            });

            // =============== SUBMIT CREATE / EDIT (AJAX) ===============
            $(document).on('submit', '#ajax-form', function (e) {
                e.preventDefault();

                const $form = $(this);

                if ($form.valid && !$form.valid()) {
                    return;
                }

                $.ajax({
                    url: $form.attr('action'),
                    type: $form.attr('method') || 'POST',
                    data: $form.serialize()
                }).done(function (resp) {
                    if (resp && resp.success) {
                        // ambil PIC terbaru dari form (setelah edit / create)
                        var newPic = ($form.find('input[name="NamaPIC"]').val() || '').toString().trim();

                        // build URL baru: tetap di halaman By PIC, tapi pakai PIC terbaru
                        var url = new URL(window.location.href);
                        if (newPic) {
                            url.searchParams.set('pic', newPic);
                        } else {
                            // fallback: kalau tidak ada PIC, hapus param pic
                            url.searchParams.delete('pic');
                        }
                        var redirectUrl = url.toString();

                        bsModal.hide();

                        if (window.Swal) {
                            Swal.fire('Berhasil', resp.message || 'Data pekerjaan berhasil disimpan.', 'success')
                                .then(function () {
                                    window.location.href = redirectUrl;
                                });
                        } else {
                            window.location.href = redirectUrl;
                        }
                    } else {
                        const msg = (resp && resp.message) || 'Terjadi kesalahan saat menyimpan data.';
                        if (window.Swal) {
                            Swal.fire('Gagal', msg, 'error');
                        } else {
                            alert(msg);
                        }
                    }
                }).fail(function () {
                    if (window.Swal) {
                        Swal.fire('Gagal', 'Terjadi kesalahan server.', 'error');
                    } else {
                        alert('Terjadi kesalahan server.');
                    }
                });
            });

            // =============== HAPUS SINGLE TASK ===============
            $(document).on('click', '.btn-delete-task', function () {
                const id = $(this).data('id');

                Swal.fire({
                    title: 'Hapus pekerjaan?',
                    text: 'Data yang sudah dihapus tidak dapat dikembalikan.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Ya, hapus',
                    cancelButtonText: 'Batal',
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    reverseButtons: false,
                    focusCancel: true
                }).then((result) => {
                    if (!result.isConfirmed) return;

                    $.post('@Url.Action("Delete")',
                        {
                            id: id,
                            __RequestVerificationToken: getAfToken()
                        }
                    ).done(function (resp) {
                        if (resp && resp.success) {
                            Swal.fire('Berhasil', resp.message || 'Pekerjaan berhasil dihapus.', 'success')
                                .then(() => location.reload());
                        } else {
                            Swal.fire('Gagal', (resp && resp.message) || 'Gagal menghapus pekerjaan.', 'error');
                        }
                    }).fail(function () {
                        Swal.fire('Gagal', 'Terjadi kesalahan server.', 'error');
                    });
                });
            });

            // =============== CHECKBOX & BULK DELETE ===============
            const $checkAllTop = $('#wt-check-all');
            const $btnBulk = $('#btn-bulk-delete');

            function refreshBulkButton() {
                const any = $('.wt-check-row:checked').length > 0;
                $btnBulk.prop('disabled', !any);

                if (any) {
                    $btnBulk.removeClass('d-none');
                } else {
                    $btnBulk.addClass('d-none');
                }
            }

            $checkAllTop.on('change', function () {
                const checked = $(this).is(':checked');
                $('.wt-check-row').prop('checked', checked);
                refreshBulkButton();
            });

            $(document).on('change', '.wt-check-row', function () {
                const total = $('.wt-check-row').length;
                const selected = $('.wt-check-row:checked').length;
                $checkAllTop.prop('checked', selected === total && total > 0);
                refreshBulkButton();
            });

            $btnBulk.on('click', function () {
                const ids = $('.wt-check-row:checked').map(function () {
                    return $(this).val();
                }).get();

                if (!ids.length) return;

                Swal.fire({
                    title: 'Hapus pekerjaan terpilih?',
                    text: 'Data yang sudah dihapus tidak dapat dikembalikan.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Ya, hapus semua',
                    cancelButtonText: 'Batal',
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    reverseButtons: false,
                    focusCancel: true
                }).then((result) => {
                    if (!result.isConfirmed) return;

                    $.post('@Url.Action("BulkDelete")',
                        {
                            ids: ids,
                            __RequestVerificationToken: getAfToken()
                        }
                    ).done(function (resp) {
                        if (resp && resp.success) {
                            Swal.fire('Berhasil', resp.message || 'Pekerjaan terpilih berhasil dihapus.', 'success')
                                .then(() => location.reload());
                        } else {
                            Swal.fire('Gagal', (resp && resp.message) || 'Gagal menghapus pekerjaan.', 'error');
                        }
                    }).fail(function () {
                        Swal.fire('Gagal', 'Terjadi kesalahan server.', 'error');
                    });
                });
            });
        });
    </script>
}
