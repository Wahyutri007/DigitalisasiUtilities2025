@model UtilitiesHR.Controllers.UsersController.EditUserVM

@{
    ViewData["Title"] = "Edit Akun";
    Layout = null; // dipakai di dalam #ajax-modal
    var canManageAkun = User.IsInRole("SuperAdmin");
}

<h5 class="mb-3">Edit Akun</h5>

<form asp-action="Edit" method="post" id="user-edit-form">
    @Html.AntiForgeryToken()

    <!-- ID user & relasi EmployeeId harus ikut terkirim -->
    <input type="hidden" asp-for="Id" />
    <input type="hidden" asp-for="EmployeeId" />

    <div asp-validation-summary="ModelOnly" class="text-danger mb-2"></div>

    <div class="mb-3">
        <label class="form-label">Nama Lengkap</label>
        <input asp-for="FullName" class="form-control" />
        <span asp-validation-for="FullName" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label class="form-label">Email (login)</label>
        <input asp-for="Email" class="form-control" type="email" />
        <span asp-validation-for="Email" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label class="form-label">Password baru (opsional)</label>
        <input asp-for="NewPassword" class="form-control" type="password" autocomplete="new-password" />
        <span asp-validation-for="NewPassword" class="text-danger"></span>
        <div class="form-text">Kosongkan jika tidak ingin mengganti password.</div>
    </div>

    <div class="mb-3">
        <label class="form-label">Konfirmasi password baru</label>
        <input asp-for="ConfirmPassword" class="form-control" type="password" autocomplete="new-password" />
        <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
    </div>

    @if (canManageAkun)
    {
        <div class="mb-3">
            <label class="form-label">Role</label>
            <select asp-for="SelectedRole" class="form-select" asp-items="ViewBag.Roles"></select>
            <div class="form-text">
                Role yang tersedia: User, Admin, SuperAdmin, Supervisor.
            </div>
        </div>
    }

    <div class="mt-3">
        <div class="d-grid gap-2">
            <button class="btn btn-primary" type="submit">
                <i class="bi bi-save me-1"></i> Simpan
            </button>
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                Batal
            </button>
        </div>
        <small class="text-muted d-block mt-2 text-center text-md-start">
            Perubahan akan langsung tersimpan ke akun.
        </small>
    </div>
</form>

<script>
    (function () {
        const $form = $('#user-edit-form');
        if (!$form.length) return;

        // kalau pakai unobtrusive validation
        if ($.validator && $.validator.unobtrusive) {
            $.validator.unobtrusive.parse($form);
        }

        $form.on('submit', function (e) {
            e.preventDefault();

            const $f = $(this);

            if ($f.valid && !$f.valid()) {
                return;
            }

            $.ajax({
                url: $f.attr('action'),
                type: 'POST',
                data: $f.serialize(),
                success: function (resp) {
                    if (resp && resp.success) {
                        Swal.fire(
                            'Berhasil',
                            resp.message || 'Data akun berhasil diupdate.',
                            'success'
                        ).then(function () {
                            const modalEl = document.getElementById('ajax-modal');
                            if (modalEl) {
                                const modal = bootstrap.Modal.getInstance(modalEl)
                                    || new bootstrap.Modal(modalEl);
                                modal.hide();
                            }
                            window.location.reload();
                        });
                    } else {
                        let msg = (resp && resp.message)
                            ? resp.message
                            : 'Gagal menyimpan perubahan akun.';

                        if (resp && resp.errors && resp.errors.length) {
                            msg += "<ul class='mt-2 text-start'>";
                            resp.errors.forEach(function (e) {
                                msg += "<li>" + e + "</li>";
                            });
                            msg += "</ul>";

                            Swal.fire({
                                title: 'Gagal',
                                html: msg,
                                icon: 'error'
                            });
                        } else {
                            Swal.fire('Gagal', msg, 'error');
                        }
                    }
                },
                error: function () {
                    Swal.fire(
                        'Error',
                        'Terjadi kesalahan pada server.',
                        'error'
                    );
                }
            });
        });
    })();
</script>
